<match fwd.raw.df>
  type rewrite_tag_filter

  rewriterule1 hostname (.+) tmp.df.$1
</match>

<match tmp.df.*>
  type forest
  subtype growthforecast

  remove_prefix tmp

  <template>
    gfapi_url http://localhost:5125/api/
    service host:${tag_parts[1]}
    section df
    name_key_pattern capacity
    keeplive true
    enable_float_number true
  </template>
</match>

<match fwd.raw.dstat>
  type rewrite_tag_filter

  rewriterule1 hostname (.+) tmp.dstat.$1
</match>

<match tmp.dstat.*>
  type forest
  subtype copy

  <template>
    <store>
      type map
      tag ("dstat.cpu.${tag_parts[2]}")
      time time
      record record['dstat']['total_cpu_usage']
    </store>

    <store>
      type map
      tag ("dstat.memory.${tag_parts[2]}")
      time time
      record record['dstat']['memory_usage']
    </store>

    <store>
      type map
      tag ("dstat.loadavg.${tag_parts[2]}")
      time time
      record record['dstat']['load_avg']
    </store>

    <store>
      type map
      tag ("dstat.network.${tag_parts[2]}")
      time time
      record record['dstat']['net/total']
    </store>

    <store>
      type map
      tag ("dstat.disk_io.${tag_parts[2]}")
      time time
      record record['dstat']['dsk/total']
    </store>

    <store>
      type map
      tag ("dstat.tcp.${tag_parts[2]}")
      time time
      record record['dstat']['tcp_sockets']
    </store>

    <store>
      type map
      tag ("dstat.udp.${tag_parts[2]}")
      time time
      record record['dstat']['udp']
    </store>

    <store>
      type map
      tag ("dstat.swap.${tag_parts[2]}")
      time time
      record record['dstat']['swap']
    </store>

    <store>
      type map
      tag ("dstat.paging.${tag_parts[2]}")
      time time
      record record['dstat']['paging']
    </store>
  </template>
</match>

<match dstat.*.*>
  type forest
  subtype growthforecast

  remove_prefix dstat

  <template>
    gfapi_url http://localhost:5125/api/
    section ${tag_parts[0]}
    service host:${tag_parts[1]}
    name_key_pattern .*
    keeplive true
    enable_float_number true
  </template>
</match>
